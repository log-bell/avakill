# OpenAI Codex CLI Hook Adapter Design

**Date:** 2026-02-20
**Status:** Approved

## Problem

AvaKill supports hook adapters for Claude Code, Gemini CLI, Cursor, and Windsurf — but not OpenAI's Codex CLI. Users wanting guardrails for Codex fall back to macOS sandbox-exec, losing audit logs, dashboard visibility, and `avakill logs` integration.

## Research Findings

Codex CLI (openai/codex, Rust-based) does **not** currently support pre-execution hooks:

- Only `after_tool_use` and `after_agent` events exist (post-execution)
- Multiple community PRs for `before_tool_use` hooks were submitted but closed
- The only external process mechanism is `notify` in `config.toml` (post-turn only)
- Issue #2109 (pre-execution hooks) remains open

Codex's pre-execution control uses:
- **Exec policy rules** (`.rules` files with Starlark `prefix_rule()`) — shell commands only
- **Approval policies** (`approval_policy` in `config.toml`) — coarse-grained

The `after_tool_use` payload format is well-defined and the tool names are known.

## Design

### Approach: Dual-mode anticipatory adapter

Build a full adapter that supports two stdin formats with auto-detection, plus exec policy `.rules` file generation for immediate shell command protection.

### 1. Adapter Module (`src/avakill/hooks/openai_codex.py`)

**Class:** `OpenAICodexAdapter(HookAdapter)`, `agent_name = "openai-codex"`

**`parse_stdin()` — dual-mode auto-detect:**

Checks for `hook_event` key. If present, uses nested Codex `HookPayload` format. If absent, uses flat format.

Codex nested format (anticipated `before_tool_use`):
```json
{
  "session_id": "...",
  "cwd": "/path",
  "hook_event": {
    "event_type": "before_tool_use",
    "call_id": "call_xxx",
    "tool_name": "shell",
    "tool_kind": "function",
    "tool_input": {
      "input_type": "local_shell",
      "params": {"command": ["rm", "-rf", "/"], "workdir": "/tmp"}
    }
  }
}
```

Flat format (generic):
```json
{
  "tool_name": "shell",
  "tool_input": {"command": "rm -rf /"},
  "session_id": "..."
}
```

**Tool input normalization** for Codex's typed variants:
- `local_shell` → `{"command": "joined command string", "workdir": "..."}`
- `custom` → `{"input": "..."}`
- `mcp` → `{"mcp_server": "...", "mcp_tool": "...", "arguments": "..."}`

**`format_response()` — JSON on stdout, exit-code signaling:**
- Allow: `{"decision": "proceed"}`, exit 0
- Deny: `{"decision": "block", "message": "..."}`, exit 1
- Require approval: `{"decision": "block", "message": "Requires approval: ..."}`, exit 1

### 2. Registration and Entry Points

- `@register_adapter` decorator on class
- Add import to `src/avakill/hooks/__init__.py` `_import_all()`
- Entry point in `pyproject.toml`: `avakill-hook-openai-codex = "avakill.hooks.openai_codex:main"`

### 3. Installer Support

**Detection** — add to `AGENT_DETECTORS`:
```python
"openai-codex": lambda: (
    Path.home().joinpath(".codex").is_dir()
    or shutil.which("codex") is not None
),
```

**Installation behavior:**
Since Codex has no hook config format, `install_hook()` will:
1. Print an info message: adapter is ready, pending upstream hook support
2. Generate `~/.codex/rules/avakill.rules` with `prefix_rule()` entries from AvaKill policy

**`_AGENT_CONFIG` entry:** Includes config path, event name, and a special `pending_upstream: True` flag that `install_hook()` checks to alter behavior.

### 4. Exec Policy Rules Generation

Function `generate_codex_rules(policy_path, output_path)` translates AvaKill policy rules to Codex `.rules` format:

- `action: deny` + shell tool + `args_match: {command: [...]}` → `prefix_rule(pattern=[...], decision="forbidden")`
- `action: allow` + `command_allowlist: [git, ls]` → `prefix_rule(pattern=["git"], decision="allow")`
- `require_approval` → `decision="prompt"`
- Non-shell rules are skipped with a comment

Generated file includes header comment noting it was auto-generated by AvaKill.

Limitations:
- Only covers shell commands (not `apply_patch`, `read_file`, MCP tools)
- No rate limiting support
- No arg substring matching beyond command prefix

### 5. Tool Normalization

Add to `AGENT_TOOL_MAP` in `src/avakill/core/normalization.py`:
```python
"openai-codex": {
    "shell": "shell_execute",
    "shell_command": "shell_execute",
    "local_shell": "shell_execute",
    "exec_command": "shell_execute",
    "apply_patch": "file_write",
    "read_file": "file_read",
    "list_dir": "file_list",
    "grep_files": "content_search",
},
```

### 6. CLI Updates (`src/avakill/cli/hook_cmd.py`)

- Add `"openai-codex"` to all `click.Choice` lists
- Add to `list_hooks` table
- Update "all" agent lists

### 7. Tests (`tests/test_hooks_openai_codex.py`)

Test classes:
- `TestOpenAICodexParseStdinNested` — Codex HookPayload format (shell, apply_patch, mcp, session_id, invalid JSON)
- `TestOpenAICodexParseStdinFlat` — Flat format (shell, missing tool_input)
- `TestOpenAICodexFormatResponse` — allow/deny/require_approval responses, exit codes
- `TestCodexRulesGeneration` — deny rules, allow rules, non-shell rule skipping

## Files Modified

| File | Change |
|------|--------|
| `src/avakill/hooks/openai_codex.py` | New adapter + rules generation |
| `src/avakill/hooks/__init__.py` | Import in `_import_all()` |
| `src/avakill/hooks/installer.py` | Detection + install config |
| `src/avakill/cli/hook_cmd.py` | Add to CLI choices |
| `src/avakill/core/normalization.py` | Tool name mappings |
| `pyproject.toml` | Entry point |
| `tests/test_hooks_openai_codex.py` | New test file |
